{% extends "base.html" %}

{% block title %}คำขอการจองคอร์สของฉัน • Train My Dog{% endblock %}
{% block main_class %}flex-1 bg-slate-100{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-4 pb-16 pt-8">
  <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div>
      <h1 class="text-2xl font-bold">คำขอการจองคอร์สของฉัน</h1>
      <p class="text-slate-600 text-sm mt-1">
        ดูรายการจองจากสมาชิกในคอร์สที่คุณเป็นครูฝึก
      </p>
    </div>
    <div class="flex.items-center gap-2 text-sm">
      <span class="inline-flex px-2 py-1 rounded-full bg-amber-100 text-amber-800 font-medium">
        รอดำเนินการ: {{ pending_count }} รายการ
      </span>
    </div>
  </header>

  <form method="get" class="mb-4 flex flex-wrap items-center gap-2 text-sm">
    <span class="text-slate-600">กรองตามสถานะ:</span>
    <select name="status" class="rounded-lg border border-slate-300 px-2 py-1">
      <option value="">ทั้งหมด</option>
      <option value="pending" {% if status == 'pending' %}selected{% endif %}>รอดำเนินการ</option>
      <option value="approved" {% if status == 'approved' %}selected{% endif %}>อนุมัติแล้ว</option>
      <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>ถูกปฏิเสธ</option>
      <option value="canceled" {% if status == 'canceled' %}selected{% endif %}>ยกเลิกโดยผู้ใช้</option>
    </select>
    <button type="submit"
            class="inline-flex.items-center px-3 py-1.5 rounded-lg bg-slate-800 text-white hover:bg-slate-700">
      กรอง
    </button>
  </form>

  {% if bookings %}
    <div class="space-y-4">
      {% for b in bookings %}
        <article class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 p-4 sm:p-5">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
            <div class="space-y-1">
              <h2 class="font-semibold text-slate-900">
                {{ b.course.title }}
              </h2>
              <p class="text-sm text-slate-600">
                ผู้จอง: {{ b.user.get_full_name|default:b.user.username }}
              </p>
              <p class="text-sm text-slate-500">
                เจ้าของสุนัข: {{ b.owner_full_name }}{% if b.owner_nickname %} ({{ b.owner_nickname }}){% endif %}
              </p>
              <p class="text-sm text-slate-500">
                เบอร์โทร: {{ b.owner_phone }}
              </p>
              {% if b.round %}
                <p class="text-sm text-slate-600">
                  รอบเรียน:
                  <span class="inline-flex px-2 py-0.5 rounded bg-slate-100 ring-1 ring-slate-200">
                    {{ b.round.display_days }} {{ b.round.start_time|time:"H:i" }}–{{ b.round.end_time|time:"H:i" }}
                  </span>
                </p>
              {% endif %}
              {% if b.dog_name %}
                <p class="text-sm text-slate-600">
                  สุนัข: {{ b.dog_name }} ({{ b.dog_count }} ตัว)
                </p>
              {% endif %}
              <p class="text-xs text-slate-500">
                จองเมื่อ: {{ b.created_at|date:"d/m/Y H:i" }}
              </p>
              {% if b.message %}
                <p class="text-sm text-slate-700 mt-1">
                  <span class="font-medium text-slate-600">ข้อความจากผู้จอง:</span>
                  <span class="block text-slate-700 whitespace-pre-line mt-0.5">
                    {{ b.message }}
                  </span>
                </p>
              {% endif %}
            </div>

            <div class="flex flex-col items-end gap-3">
              <span class="inline-flex.items-center px-2 py-1 rounded-full text-xs font-semibold
                {% if b.status == 'pending' %} bg-amber-100 text-amber-800
                {% elif b.status == 'approved' %} bg-emerald-100 text-emerald-800
                {% elif b.status == 'rejected' %} bg-rose-100 text-rose-800
                {% elif b.status == 'canceled' %} bg-slate-100 text-slate-700
                {% endif %}">
                {% if b.status == 'pending' %}รอดำเนินการ
                {% elif b.status == 'approved' %}อนุมัติแล้ว
                {% elif b.status == 'rejected' %}ถูกปฏิเสธ
                {% elif b.status == 'canceled' %}ยกเลิกโดยผู้ใช้
                {% endif %}
              </span>

              {% if b.status == 'pending' %}
                <form method="post"
                      action="{% url 'trainmydog:trainer_booking_update_status' b.pk %}"
                      class="flex flex-col items-stretch gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <div class="flex gap-1">
                    <button type="submit" name="status" value="approved"
                            class="px-3 py-1.5 text-xs rounded-lg bg-emerald-600 text-white hover:bg-emerald-500">
                      อนุมัติ
                    </button>
                    <button type="submit" name="status" value="rejected"
                            class="px-3 py-1.5 text-xs rounded-lg bg-rose-600 text-white hover:bg-rose-500">
                      ปฏิเสธ
                    </button>
                  </div>
                </form>
              {% endif %}

              <form method="post"
                    action="{% url 'trainmydog:trainer_booking_delete' b.pk %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit"
                        class="text-xs text-slate-500 hover:text-red-600">
                  ลบรายการนี้
                </button>
              </form>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-200 p-6 text-center text-slate-600">
      ยังไม่มีคำขอการจองคอร์สในตอนนี้
    </div>
  {% endif %}
</main>
{% endblock %}
